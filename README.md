# Podman Quadlet playground on Fedora CoreOS

To create this playground, I based myself on the content of [this previous playground](https://github.com/stephane-klein/atomic-os-playground/tree/main/install-coreos-iso-on-qemu) to install and launch [Fedora CoreOS](https://notes.sklein.xyz/CoreOS/) in a Qemu VM.

My goal with this playground was to test [Podman Quadlets](https://notes.sklein.xyz/Podman%20Quadlets/) for the first time.

Here are the elements I installed:

- [`./shared/quadlets/postgresql.container`](./shared/quadlets/postgresql.container)
- [`./shared/quadlets/adminer.container`](./shared/quadlets/adminer.container) ([web admin interface like PhpMyAdmin](https://notes.sklein.xyz/2025-12-01_1832/zen/))

Prerequisites:

```
$ sudo dnf install \
    butane \
    coreos-installer \
    qemu-kvm
```

Download the stable x86_64 metal ISO, generate the Ignition configuration, and build the custom ISO:


```sh
$ ./create-custom-iso.sh
```

Launch the QEMU VM with the custom ISO:

```sh
$ ./up-qemu-vm.sh
```

Note: On first boot, the script installs CoreOS to the virtual disk. Subsequent boots use the installed system.

You can also connect to VM with *ssh*:

```sh
$ ./ssh-enter-vm.sh
```

I start by installing the quadlet files present in `./quadlets`:

```sh
stephane@stephane-coreos:/mnt/shared$ podman quadlet install ./quadlets/
/var/home/stephane/.config/containers/systemd/mynetwork.network
/var/home/stephane/.config/containers/systemd/postgresql.container
/var/home/stephane/.config/containers/systemd/adminer.container
```

This `podman` command generates the following Systemd units:

```
stephane@stephane-coreos:/mnt/shared$ ls -1 /run/user/1001/systemd/generator/
adminer.service
default.target.wants
mynetwork-network.service
postgresql.service
```

I can see that a systemd unit `postgresql.service` is created but not started:

```
stephane@stephane-coreos:/mnt/shared$ systemctl --user status postgresql.service
○ postgresql.service
     Loaded: loaded (/var/home/stephane/.config/containers/systemd/postgresql.container; generated)
    Drop-In: /usr/lib/systemd/user/service.d
             └─10-timeout-abort.conf
     Active: inactive (dead)
```

I start the services:

```
stephane@stephane-coreos:/mnt/shared$ systemctl --user start postgresql.service
stephane@stephane-coreos:/mnt/shared$ systemctl --user start adminer.service
```

Wait container image pulling and starting...

```
stephane@stephane-coreos:/mnt/shared$ podman ps
CONTAINER ID  IMAGE                            COMMAND               CREATED                 STATUS                 PORTS                   NAMES
65ab19ec4148  docker.io/library/postgres:18    postgres              5 seconds ago           Up 4 seconds           0.0.0.0:5432->5432/tcp  systemd-postgresql
e8c003e34e44  docker.io/library/adminer:5.4.1  php -S [::]:8080 ...  Less than a second ago  Up Less than a second  0.0.0.0:8080->8080/tcp  systemd-adminer
```

The adminer web service is accessible from the host at: http://localhost:8080/?pgsql=systemd-postgresql&username=postgres&db=postgres (Password: `password`)

That's it, the small demo scenario of the playground ends here, I can launch the teardown:

```sh
stephane@stephane-coreos:/mnt/shared$ exit
$ ./teardown.sh
```

## Additional Information

### Understanding Quadlet Auto-start Configuration

Here's an important concept I initially struggled with when working with Podman Quadlets.

When trying to enable automatic container startup at boot, I attempted to run the following command and encountered an error:

```sh
stephane@stephane-coreos:/mnt/shared$ systemctl --user enable postgresql.service
Failed to enable unit: Unit /run/user/1001/systemd/generator/postgresql.service is transient or generated  
```

Why did this fail? Because `postgresql.service` is dynamically generated by `systemctl` from the [quadlet files](./shared/quadlets/). In this scenario, running `systemctl --user enable postgresql.service` is not possible.

I later discovered that this command was unnecessary. As documented [here](https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html#enabling-unit-files), the following configuration in [`./shared/quadlets/postgresql.container`](./shared/quadlets/postgresql.container) already handles automatic container startup at boot:

```
[Install]
WantedBy=default.target
```

### Manually mount the `shared/` folder

`/mnt/shared/` is automatically mounted by [`coreos-custom-iso-config.bu`](./coreos-custom-iso-config.bu) Butane file,
but, if needed, you can configure manually:

```
stephane@stephane-coreos:/mnt/shared$ sudo mkdir -p /mnt/shared
stephane@stephane-coreos:/mnt/shared$ sudo mount -t 9p -o trans=virtio shared /mnt/shared
```
